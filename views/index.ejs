<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Red Phone Personal Assistant</title>
</head>

<body>
    <div class="container mb-2 mt-2">
        <h1 class="mb-4">Red Phone Personal Assistant</h1>
    </div>
    <div class="container mb-4">
        <a href="/ring" class="btn btn-primary mb-4 btn-block w-100">Ring the phone now</a>
    </div>

    <div class="container mb-4">
        <a href="/stopring" class="btn btn-primary mb-4 btn-block w-100">Stop the phone ringing</a>
    </div>

    <div class="container mb-4">
        <form action="/sendMessage" method="POST">
            <div>
                <label for="message">Message:</label>
                <input type="text" id="message" name="message" required class="form-control">
            </div>
            <button type="submit" class="btn btn-primary mt-4 btn-block w-100">Send the message</button>
        </form>
    </div>

    <div id="status" class="container mt-2"></div>

    <div class="container mb-4">
        <form action="/sendQuestion" method="POST">
            <div>
                <label for="question">Question:</label>
                <input type="text" id="question" name="question" required class="form-control">
            </div>
            <button type="submit" class="btn btn-primary mt-4 btn-block w-100">Send the question</button>
        </form>
    </div>

    <div class="container mb-4">
        <h5>Microphone</h5>
        <div class="form-row mb-2">
          <div class="col">
            <label for="deviceSelect">Capture device</label>
            <select id="deviceSelect" class="form-control">
              <option value="">System default</option>
            </select>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="saveDefaultDevice">
              <label class="form-check-label" for="saveDefaultDevice">Save as default</label>
            </div>
          </div>
          <div class="col-3 d-flex align-items-end">
            <button id="refreshDevices" type="button" class="btn btn-outline-secondary btn-block">Refresh</button>
          </div>
        </div>
        <div class="btn-group w-100" role="group" aria-label="Microphone controls">
            <button id="micStartButton" type="button" class="btn btn-success">Start Recording</button>
            <button id="micStopButton" type="button" class="btn btn-danger">Stop Recording</button>
        </div>
    </div>

    <div class="container mt-3">
       <p> <%= message %> </p> 
    </div>




<script>
  (function () {
    const startBtn = document.getElementById('micStartButton');
    const stopBtn = document.getElementById('micStopButton');
    const status = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshDevices');
    const deviceSelect = document.getElementById('deviceSelect');

    function setStatus(text) {
      status.innerText = text;
    }

    async function fetchDevices(defaultDevice){
      try {
        refreshBtn.disabled = true;
        const resp = await fetch('/devices');
        const devices = await resp.json();
        // Clear existing options (keep first default)
        deviceSelect.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.text = 'System default';
        deviceSelect.appendChild(defaultOption);
        for (const d of devices){
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.text = d.label;
          deviceSelect.appendChild(opt);
        }
        // If a default device is provided, try to set it
        if (defaultDevice){
          deviceSelect.value = defaultDevice;
        }
      } catch (err){
        console.error('Failed to fetch devices:', err);
      } finally {
        refreshBtn.disabled = false;
      }
    }

    refreshBtn.addEventListener('click', (e) => {
      fetchConfigAndDevices();
    });

    async function fetchConfigAndDevices(){
      try{
        const resp = await fetch('/config');
        const cfg = await resp.json();
        const defaultDevice = cfg.soundDevice || null;
        await fetchDevices(defaultDevice);
      } catch (err){
        console.error('Failed to fetch config:', err);
        await fetchDevices();
      }
    }

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      stopBtn.disabled = true;
      refreshBtn.disabled = true;
      setStatus('Starting recording...');
      try {
        const selectedDevice = deviceSelect.value || null;
        const body = selectedDevice ? { device: selectedDevice } : {};
        const resp = await fetch('/startRecording', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const j = await resp.json();
        if (j.ok) {
          setStatus(`Recording started: ${j.filename}${j.device ? ' (device: ' + j.device + ')' : ''}`);
          // If user asked to save as default, persist
          const saveDefault = document.getElementById('saveDefaultDevice').checked;
          if (saveDefault && selectedDevice){
            try{
              const sresp = await fetch('/config/device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device: selectedDevice })
              });
              const sj = await sresp.json();
              if (!sj.ok) {
                console.warn('Failed to save default device', sj);
              } else {
                setStatus(`Default device saved: ${sj.device}`);
              }
            } catch(err){
              console.warn('Failed to save default device', err);
              setStatus('Failed to save default device');
            }
          }

          startBtn.disabled = true;
          stopBtn.disabled = false;
        } else {
          setStatus(`Error starting recording: ${j.err}`);
          startBtn.disabled = false;
          refreshBtn.disabled = false;
        }
      } catch (err) {
        setStatus(`Network error: ${err}`);
        startBtn.disabled = false;
        refreshBtn.disabled = false;
      }
    });

    stopBtn.addEventListener('click', async () => {
        startBtn.disabled = true;
        stopBtn.disabled = true;
        setStatus('Stopping recording...');
        try {
            const resp = await fetch('/stopRecording', { method: 'POST' });
            const j = await resp.json();
            if (j.ok) {
            setStatus(`Recording stopped â€” length ${j.lengthInMs ?? 'unknown'} ms`);
            startBtn.disabled = false;
            stopBtn.disabled = true;
            refreshBtn.disabled = false;
            } else {
            setStatus(`Error stopping recording: ${j.err}`);
            stopBtn.disabled = false;
            refreshBtn.disabled = false;
            }
        } catch (err) {
            setStatus(`Network error: ${err}`);
            stopBtn.disabled = false;
            refreshBtn.disabled = false;
        }
    });

    // initial state
    startBtn.disabled = false;
    stopBtn.disabled = true;
    fetchDevices();
  })();
</script>

</body>
</html>